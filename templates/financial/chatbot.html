{% extends 'financial/base.html' %}

{% block title %}AI Chatbot - FinanceAI{% endblock %}

{% block content %}
<h1>ðŸ’¬ AI Financial Chatbot</h1>
<p>Get personalized financial advice from our AI assistant powered by advanced language models.</p>

<div class="chat-container">
    <div class="chat-messages" id="chatMessages">
        <div class="message assistant">
            <div class="message-content">
                ðŸ‘‹ Hello! I'm your AI financial assistant. I can help you with budgeting, investing, savings strategies, and financial planning. What would you like to know today?
            </div>
        </div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="Ask me about personal finance, budgeting, investments..." autocomplete="off">
        <button id="sendBtn">Send</button>
    </div>
</div>

<div class="loading" id="loading">AI is thinking...</div>

<script>
function formatResponse(text) {
    let formatted = text;
    
    // Headers
    formatted = formatted.replace(/^### (.*?)$/gm, '<strong style="color: #3b82f6; display: block; margin-top: 0.5rem; margin-bottom: 0.25rem;">â–¸ $1</strong>');
    formatted = formatted.replace(/^## (.*?)$/gm, '<strong style="color: #3b82f6; display: block; margin-top: 0.75rem; margin-bottom: 0.5rem; font-size: 1.1em;">â–ª $1</strong>');
    formatted = formatted.replace(/^# (.*?)$/gm, '<strong style="color: #3b82f6; display: block; margin-top: 1rem; margin-bottom: 0.75rem; font-size: 1.2em;">â–  $1</strong>');
    
    // Bold
    formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Italic
    formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Numbered lists
    formatted = formatted.replace(/^\d+\.\s+(.*?)$/gm, '<div style="margin-left: 1rem; margin-bottom: 0.25rem;">â€¢ $1</div>');
    
    // Bullet lists
    formatted = formatted.replace(/^[\*\+]\s+(.*?)$/gm, '<div style="margin-left: 1rem; margin-bottom: 0.25rem;">â—¦ $1</div>');
    
    return formatted;
}

const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const loading = document.getElementById('loading');

function addMessage(text, isUser) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (isUser) {
        contentDiv.textContent = text;
    } else {
        contentDiv.innerHTML = formatResponse(text);
    }
    
    messageDiv.appendChild(contentDiv);
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;
    
    addMessage(message, true);
    chatInput.value = '';
    loading.classList.add('show');
    
    try {
        const response = await fetch('{% url "financial:chat_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        loading.classList.remove('show');
        
        if (data.response) {
            addMessage(data.response, false);
        } else if (data.error) {
            addMessage(`Error: ${data.error}`, false);
        }
    } catch (error) {
        loading.classList.remove('show');
        addMessage(`Error: ${error.message}`, false);
    }
}

sendBtn.addEventListener('click', sendMessage);
chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});
</script>
{% endblock %}
